 +

[[IBMCloudDevOpsPlugin-DevOpsInsightsOverview]]
== DevOps Insights Overview

This plugin lets you integrate Jenkins
with https://console.ng.bluemix.net/catalog/services/devops-insights?taxonomyNavigation=apps[IBM
DevOps Insights]. DevOps Insights tracks your deployment risk based on
the test data that you publish to it. This test data may include unit
tests, code coverage, functional verification tests, SonarQube data, and
scan data from IBM Application Security on Cloud.  Once you publish this
data, you can add gates to your pipelines so that you can stop builds
that don't meet risk policies.

You can also use DevOps Insights to analyze your code repositories,
which can yield valuable information about error-prone files, commit
trends, and team dynamics.

Here is the Quality Dashboard view that shows which Applications perform
which type of tests.  For example, synthetic-agent does Code Coverage,
Unit Test, Functional Verification Test but does not perform SonarQube
tests.  From this view, you can also navigate to trends graph so that
you can see trends for a specific application for a specific test
type.  

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/01-Quality_Dashboard.png[image,height=400]#

 +

 +

The Quality Data Set view can show quality data by a specific branch. 
If you use multiple branches for various environments, you can view this
data by branch.

The tool lets you specify the types of tests (Data Sets) that you want
to represent in the system with just a few clicks.  In the above
screenshot, the user has created "Sandbox Unit Test", "Upgrade
Verification Test" etc. Once you define a Data Set, you can create a
policy with rules around the Data Set. Once you start populating data
for a Data Set, the Data Set will appear in the Quality Dashboard when
your pipeline runs.  You can also reorder the columns of the Quality
Dashboard.

 +

You can define one more policies that can be used to determine if a
specific build should be promoted to the next environment.  Since
applications in a project have different levels of maturity, you can
create separate policies for each application or even have multiple
policies for a single application.  Each policy has one or more rules. 

This is an example of a policy containing seven rules.

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/02-Policy.png[image,width=700]#

 +

 +

This is an example of a Code Coverage rule.

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/03-Rule.png[image,width=700]#

 +

This is an example of a Unit Test rule:

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/04-Unit_test.png[image,width=700]#

 +

You can also create rules on any custom Data Sets that you created.  For
example, if you created a Data Set for "Integration Test", you can
create a rule for that Data Set in your policies.

 +

Here is a view that shows deployment risk associated with various
microservices that are deployed in an environment.

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/05-RA.png[image,width=700]#

 +

Here is a view that shows deployment risk.  This view shows all builds
that are in flight for a given Microservice and their deployment risk.  

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/06-RA.png[image,width=700]#

Here is a view that shows deployment risk details for a specific
microservice and build.  At the top, the UI provides information about
last commit for the build and link to Jenkins for that specific build.

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/07-RA.png[image,width=700]#

Then, the UI can show details of a specific test as well.  In some
cases, it will point to the original tool for details.

 +

With this information on their fingertips, devops teams know which build
is deployed in which environment, the quality of each build, link to
commits and automated risk analysis based on the thresholds that an
admin sets.   All stakeholders can have access to this information to
view how their development teams are performing.

 +

You can also view trends for unit test and functional verification tests
for the builds that are from a certain branch or deployed to a certain
environment.  For example, you can see test trends for builds from the
master branch.  If some tests have been failing for builds that went to
production, you may want to take some action.  Also, if number of tests
are dwindling over time, that may also be a cause for concern.

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/08-Trends.png[image,width=700]#

 +

You can also view code coverage trends for the builds that are deployed
to a certain environment.  For example, you can see code coverage trends
for builds that went to production.  Ideally, you should see that code
coverage improve over time for builds that went to production.  If code
coverage has been going down, you may want to take action.

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/09-Trends.png[image,width=700]#

 +

You can also view deployment frequency trends for your production,
staging or other environments.  This view also shows deployment success
and failures.  You can click on a point of interest and see deployment
details.  If yours is an agile team, you should see the deployment
frequency trends go up.

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/10-Deployments.png[image,width=700]#

 +

You can also view build frequency trends for your long running branches.
 This view also shows build success and failures.  You can click on a
point of interest and see build details.  If yours is an agile team, you
should see a lot of daily builds on the integration branch.  Otherwise,
your team is not merging their code frequently.

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/11-Build.png[image,width=700]#

 +

[[IBMCloudDevOpsPlugin-SupportedToolsandFormats]]
== Supported Tools and Formats

We currently support the following test formats.

[width="99%",cols="46%,54%",options="header",]
|===
|Type |Formats
|Unit Test |JUnit (json), xUnit (xml), Mocha (json), KarmaMocha (json)

|Function Tests |JUnit (json), xUnit (xml), Mocha (json), KarmaMocha
(json)

|Code Coverage |Cobertura (xml), lcov, Istanbul (json), JaCoCo (xml)

|Sonarqube |Sonarqube

|Static Security Scan |IBM Application Security on Cloud (xml)

|Dynamic Security Scan |IBM Application Security on Cloud (xml)

|IBM Vulnerability Advisor |IBM Vulnerability Advisor (json)

|Custom Data Sets - Tests |JUnit (json), xUnit (xml), Mocha (json),
KarmaMocha (json)

|Custom Data Sets - Code Coverage |Cobertura (xml), lcov, Istanbul
(json), JaCoCo (xml)
|===

 +

For golang https://github.com/axw/gocov/[gocov] users, please convert to
Cobertura using https://github.com/yaoyaozong/gocov-xml[gocov
XML(Cobertura) export]

[[IBMCloudDevOpsPlugin-ConnectwithUs]]
== Connect with Us

For a demo and technical deep dive, please connect with Vijay Aggarwal
via https://www.linkedin.com/in/vijay-aggarwal/[Linked In] or via
mailto:aggarwav@us.ibm.com[email].

[[IBMCloudDevOpsPlugin-SamplePipelinesandCode]]
== Sample Pipelines and Code

Here are two complete pipeline examples defined
as https://github.com/jenkinsci/ibm-cloud-devops-plugin/blob/master/Declarative-Jenkinsfile[declarative
Jenkinsfile] and
a https://github.com/jenkinsci/ibm-cloud-devops-plugin/blob/master/Scripted-Jenkinsfile[scripted
Jenkinsfile]. 

This https://github.com/devops-insights/DemoDRA[git repo] contains a
sample nodejs application code and tests, as well as a Jenkinsfile, you
can play with it by simply forking this repo and modifying the
Jenkinsfile to replace all the placeholder with your actual information.
(Note: if you don't have NodeJS installed in your Jenkins environment,
you might have to install the node.js Jenkins plugin. If you do have
NodeJS installed, you can comment out the "tools" section in the
Jenkinsfile)

[[IBMCloudDevOpsPlugin-Prerequisites]]
== Prerequisites

At a high level, here are the integration steps.  These steps are
described later in this document.

* An IBM Cloud account. https://console.bluemix.net/[Create account]
* A DevOps toolchain. Learn more about
https://console.ng.bluemix.net/docs/services/ContinuousDelivery/toolchains_about.html#toolchains_about[toolchains
here].
* The Jenkins
plugin. https://plugins.jenkins.io/ibm-cloud-devops[Install plugin]
* DevOps Insights

[[IBMCloudDevOpsPlugin-Creatingatoolchain]]
== Creating a toolchain

Before you can integrate DevOps Insights with a Jenkins project, you
must create a toolchain and add the DevOps Insights and Jenkins tools to
it.  +
 +
First, create an empty toolchain that you can add tools to. 

. Go to the https://console.ng.bluemix.net/devops/create[Create a
Toolchain page]. 
. Under Other Templates, click the *Build your own toolchain* template.
. Name the toolchain and click *Create*. 

Next, add the DevOps Insights and Jenkins tools to your toolchain. 

. On the toolchain's Overview page, click *Add a tool.*
. Click the *DevOps Insights* tile, and then click *Create Integration*.
. On the toolchain's Overview page, click *Add a tool* again.
. Click the *Jenkins* tile. 
. Enter the name and URL for your existing Jenkins project. 
. Click *Create Integration. *

You now have a toolchain that lets use DevOps Insights with Jenkins.

[[IBMCloudDevOpsPlugin-IntegratingJenkinsPipelinewithDevOpsInsights]]
== Integrating Jenkins Pipeline with DevOps Insights

. Install this plugin using the plugin manager
([.underline]#https://plugins.jenkins.io/ibm-cloud-devops)#. This plugin
supports
both https://jenkins.io/doc/book/pipeline/syntax/#declarative-pipeline[declarative] or https://jenkins.io/doc/book/pipeline/syntax/#scripted-pipeline[scripted] formats.
 It also supports Jenkins jobs.
. Connect your application

Open the pipeline definition or script and add these environment
variables 

In the definition, add the following environment variables. These
variables are required for the pipeline to integrate with DevOps
Insights.

[cols=",",options="header",]
|===
|Environment variable |Definition
a|
 IBM_CLOUD_DEVOPS_API_KEY

 +
 

a|
 +

This is a unique code that is passed in to an application programming
interface (API) to identify the calling application or user. 

To create an API key in IBM Cloud: Select Manage → Security → Platform
API Keys in the header of the page.  Click create and name the API key.
You can follow
https://console.bluemix.net/docs/iam/apikeys.html#creating-an-api-key

Store the API key as Jenkins credentials. (secret text type).

 +

|IBM_CLOUD_DEVOPS_APP_NAME |The name of the application that your
toolchain deploys. If applicationName parameter is passed to the step
job then this value is ignored for that step.

|IBM_CLOUD_DEVOPS_TOOCLHAIN_ID a|
The ID of your toolchain. To find the Toolchain ID: 

On the page containing your toolchain, select the toolchain with Jenkins
(show screenshot) to see the Toolchain Overview page. Look in the
address bar for the URL to determine the Toolchain ID. 

For example:
https://console.bluemix.net/devops/toolchains/99c643c3-23d9-4030-9b1f-3aadfd7f9d09?env_id=ibm:yp:us-south[https://console.bluemix.net/devops/toolchains/99c643c3-23d9-4030-9b1f-3aadfd7f9d09]

Toolchain ID: 99c643c3-23d9-4030-9b1f-3aadfd7f9d09

|===

 +
Tip: See
the https://jenkins.io/doc/pipeline/tour/environment/#credentials-in-the-environment[Jenkins
pipeline documentation] for more information about
the `+credentials+` command.

Tip: If you are using the the scripted pipeline format, set your
credentials with `+withCredentials+` and your environment
with `+withEnv+` instead of `+credentials+` and `+environment+`, which
are used in the example below.
See https://jenkins.io/doc/pipeline/steps/credentials-binding/[the
Jenkins documentation] for more about `+withCredentials+`.

 +

These environment variables and credentials are used by the IBM Cloud
DevOps plugin to interact with DevOps Insights. Here is an example of
setting them in the declarative pipeline format.

[source,syntaxhighlighter-pre]
----
environment {
        IBM_CLOUD_DEVOPS_API_KEY = credentials('BM_API_KEY')
        IBM_CLOUD_DEVOPS_APP_NAME = 'Weather-App'
        IBM_CLOUD_DEVOPS_TOOLCHAIN_ID = '1111111-aaaa-2222-bbbb-333333333'
    }
----

[[IBMCloudDevOpsPlugin-AddingCloudDevOpssteps]]
=== Adding Cloud DevOps steps

The Cloud DevOps plugin adds four steps to Jenkins pipelines for you to
use. Use these steps in your pipelines to interact with DevOps Insights.

* `+publishBuildRecord+`, which publishes build information to DevOps
Insights
* `+publishTestResult+`, which publishes test results to DevOps Insights
* `+publishDeployRecord+`, which publishes deployment records to DevOps
Insights
* `+evaluateGate+`, which enforces DevOps Insights policies

Add these steps to your pipeline definition wherever you need them to
run. For example, you might upload test results after running a test,
and then evaluate those results at a gate after they are uploaded.

Tip: by default, the version number is set to be \{pipeline
name}:\{build number}, you can also set the custom version number in
each step

[[IBMCloudDevOpsPlugin-Publishingbuildrecords]]
==== Publishing build records

Publish build records with the `+publishBuildRecord+` step. This step
requires four parameters. It can also accept one optional parameter.

[cols=",",options="header",]
|===
|Parameter |Definition
|`+gitBranch+` |The name of the Git Branch that the build uses.

|`+gitCommit+` |The Git commit ID that the build uses.

|`+gitRepo+` |The URL of the Git repository.

|`+result+` |The result of the build stage. The value should
be `+SUCCESS+` or `+FAIL+`.

a|
....
buildNumber
....

|_Optional:_ Set value to any string - this represents version number

|`+applicationName+` |_Optional_: Set the application name. If this
value is set the environment variable IBM_CLOUD_DEVOPS_APP_NAME will be
ignored.
|===

Here are the parameters in an example command:

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/12-build_example.png[image,width=700]#

Tip: Jenkins Pipeline does not expose Git information as environment
variables. You can get the Git commit ID by using the
command `+sh(returnStdout: true, script: 'git rev-parse HEAD').trim()+`.

 

[[IBMCloudDevOpsPlugin-Publishingtestresults]]
==== Publishing test results

 

Publish build records with the `+publishTestResult+` step. This step
requires two parameters. It can also accept one optional parameter.

 +

[cols=",",options="header",]
|===
|Parameter |Definition
|`+type+` |The type of test result. The value of this can
be `+unittest+` for unit tests, `+fvt+` for functional verification
tests, `+code+` for code coverage tests, `+staticsecurityscan+` for
static security scan result, dynamicsecurityscan for dynamic security
scan, or any other tag that you defined from Control Center

|`+fileLocation+` |The test result file's location.

a|
....
environment
....

|The environment name that your test runs on, only required for fvt
(functional verification tests)

a|
....
buildNumber
....

|_Optional:_ Set value to any string - this represents version number

|`+applicationName+` |__Optional__: Set the application name. If this
value is set the environment variable IBM_CLOUD_DEVOPS_APP_NAME will be
ignored.
|===

 +

 

Here are the parameters in example commands. The first command publishes
Mocha unit test results, and the second command publishes code coverage
test results.

[source,syntaxhighlighter-pre]
----
publishTestResult type:'unittest', fileLocation: './mochatest.json'
publishTestResult type:'code', fileLocation: './tests/coverage/reports/coverage-summary.json'
publishTestResult type:'fvt', fileLocation: './mochafvt.json', environment: 'STAGING'
publishTestResult type:'staticsecurityscan', fileLocation: './static-result.xml'
publishTestResult type:'dynamicsecurityscan', fileLocation: './dynamic-result.xml'
publishTestResult type:'vulnerabilityadvisor', fileLocation: './vulnerability-advisor.json'
----

[[IBMCloudDevOpsPlugin-PublishingSonarQuberesults]]
====  +
Publishing SonarQube results

After you configure a SonarQube scanner and server by following the
instructions in
the https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner+for+Jenkins[SonarQube
docs], you can publish scan results to DevOps Insights.

To configure your Jenkins Pipeline to accept these results, add the
following three required parameters and one optional parameter to it:

 

[cols=",",options="header",]
|===
|Parameter |Definition
|`+SQHostURL+` |The host portion of your SonarQube scanner's URL. Get
this from from your SonarQube server.

a|
....
SQAuthToken
....

|Your SonarQube API authentication token. Get this from your SonarQube
server.

a|
....
SQProjectKey
....

|The project key of the SonarQube project you wish to scan.

a|
....
buildNumber
....

|_Optional:_ Set value to any string - this represents version number

|`+applicationName+` |__Optional__: Set the application name. If this
value is set the environment variable IBM_CLOUD_DEVOPS_APP_NAME will be
ignored.
|===

 +

Here are the SonarQube parameters used in a sample stage:

[source,syntaxhighlighter-pre]
----
stage ('SonarQube analysis') {
    steps {
        script {
            def scannerHome = tool 'Default SQ Scanner';
            withSonarQubeEnv('Default SQ Server') {
               
                env.SQ_HOST_URL = SONAR_HOST_URL;
                env.SQ_AUTHENTICATION_TOKEN = SONAR_AUTH_TOKEN;
                env.SQ_PROJECT_KEY = "My Project Key";
                
                run SonarQube scan ...
            }
        }
    }
}
stage ("SonarQube Quality Gate") {
     steps {
        ...
     }
     post {
        always {
            publishSQResults SQHostURL: "${SQ_HOST_URL}", SQAuthToken: "${SQ_AUTHENTICATION_TOKEN}", SQProjectKey:"${SQ_PROJECT_KEY}"
        }
     }
}
----

[[IBMCloudDevOpsPlugin-Publishingdeploymentrecords]]
====  +
Publishing deployment records

 

Publish deployment records with the `+publishDeployRecord+` step. This
step requires two parameters. It can also accept two optional parameter.

 +

[cols=",",options="header",]
|===
|Parameter |Definition
|`+environment+` |The environment that you deploy your app to. For
example, "DEV" or "STAGING" or any other value

|`+result+` |The result of the build stage. The value should
be `+SUCCESS+` or `+FAIL+`.

|`+appUrl+` |_Optional_: The URL used to access your application.

a|
....
buildNumber
....

|_Optional:_ Set value to any string - this represents version number

|`+applicationName+` |__Optional__: Set the application name. If this
value is set the environment variable IBM_CLOUD_DEVOPS_APP_NAME will be
ignored.
|===

 +

 

Here are the parameters in example commands. The first command publishes
the deployment record for a staging environment; the second command
publishes the deployment record for a production environment.

[source,syntaxhighlighter-pre]
----
publishDeployRecord environment: "STAGING", appUrl: "http://staging-Weather-App.mybluemix.net", result:"SUCCESS"
publishDeployRecord environment: "PRODUCTION", appUrl: "http://Weather-App.mybluemix.net", result:"SUCCESS"
----

 

[[IBMCloudDevOpsPlugin-Addinggates]]
==== Adding gates

The first step is to define Gate Policies.  Policies are sets of rules
that control the gates in your delivery pipeline. If your code does not
meet or exceed a policy that is enacted at a particular gate, the
deployment is halted to prevent risky changes from being released.

 

You define policies in DevOps Insights, rather than in Jenkins.

 

To open the DevOps Insights Policies page: 

 

. Open DevOps Insights and select Policies in the sidebar navigation.
. Select 'Create New Policy' and name your policy
. Add a rule. _(*yes, the user will have to have data before they add a
policy. It would be odd for them to add a policy on an application that
has no test results. Plus, most users run tests for a while before
adding a policy.)_
. Connect the Insights Policy to Gates in your pipeline. +
* +
*

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/02-Policy.png[image,width=700]#

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/03-Rule.png[image,width=700]#

 

From here, you can define policies, add rules to them, and then add them
to gates in your Jenkins projects.  +
For more information,
see https://console.bluemix.net/docs/services/DevOpsInsights/risk_policies.html#policies_and_rules[Creating
policies and rules] in the Bluemix documentation. 

 +

Once policies have been created, add gates to your pipeline by using
the `+evaluateGate+` command. Gates enforce DevOps Insights policies,
which set test requirements for build promotion. 

This step requires one parameters. It can also accept two optional
parameter.

 +

[cols=",",options="header",]
|===
|Parameter |Definition
|`+policy+` |The name of the policy that the gate implements. The
policy's name is defined in DevOps Insights.

a|
....
forceDecision
....

|_Optional_: Whether or not the pipeline stops depending on the gate's
decision. Set this parameter to `+true+` to stop the pipeline from
running if the gate fails. Set it to `+false+` to allow the pipeline to
continue after a gate failure. By default, the value is `+false+`.

a|
....
buildNumber
....

|_Optional:_ Set value to any string - this represents version number

|`+applicationName+` |__Optional__: Set the application name. If this
value is set the environment variable IBM_CLOUD_DEVOPS_APP_NAME will be
ignored.
|===

 

Here are the parameters in an example command. In this command, the
pipeline will continue running regardless of the gate's decision.

[source,syntaxhighlighter-pre]
----
evaluateGate policy: 'Weather App Policy', forceDecision: 'true'
----

 

[[IBMCloudDevOpsPlugin-Communicatingwithtoolchains]]
==== Communicating with toolchains

Send pipeline status to IBM Cloud DevOps toolchains by using
the `+notifyOTC+` command. To learn more about integrating Jenkins with
toolchains, see
https://wiki.jenkins-ci.org/display/JENKINS/IBM+Cloud+DevOps+Plugin#IBMCloudDevOpsPlugin-Notifyingtoolchains[Notifying
toolchains] section below. 

This step requires two parameters and can take an additional optional
one.

 +

[cols=",",options="header",]
|===
|Parameter |Definition
|`+stageName+` |The current pipeline stage's name.

|`+status+` |The current pipeline stage's status.
Using `+SUCCESS+`, `+FAILURE+`, or `+ABORTED+` will automatically
trigger color highlighting in Slack.

|`+webhookUrl+` |_Optional_: The webhook URL that is shown on your
toolchain's Jenkins tile. If you include this parameter, its value
overrides that of the `+IBM_CLOUD_DEVOPS_WEBHOOKURL+` environment
variable.
|===

 +

 

Here are examples of using the `+notifyOTC+` step in both declarative
and scripted pipeline definitions:

 +

[source,syntaxhighlighter-pre]
----
notifyOTC stageName: "Deploy", status: "SUCCESS"
----

 

[source,style-scope,doc-content]
----
----

[[IBMCloudDevOpsPlugin-IntegratingwithfreeformJenkinsprojects]]
== Integrating with freeform Jenkins projects

[[IBMCloudDevOpsPlugin-ConfiguringJenkinsjobsfortheDeploymentRiskdashboard]]
=== Configuring Jenkins jobs for the Deployment Risk dashboard

After the plugin is installed, you can integrate DevOps Insights into
your Jenkins project.

Follow these steps to use DevOps Insights gates and dashboard with your
project.

. Open the configuration of any jobs that you have, such as build, test,
or deployment.
. Add a post-build action for the corresponding type:
* For build jobs, use *[.style-scope .doc-content]#Publish build
information to IBM Cloud DevOps#*.
* For test jobs, use *[.style-scope .doc-content]#Publish test result to
IBM Cloud DevOps#*.
* For SonarQube jobs, use *Publish SonarQube test result to IBM Cloud
DevOps*.
* For deployment jobs, use *[.style-scope .doc-content]#Publish
deployment information to IBM Cloud DevOps#*.
. Complete the required fields. These will vary depending on job type.
* From the *[.style-scope .doc-content]#Credentials#* list, select your
IBM Cloud API key. If they are not saved in Jenkins,
click *[.style-scope .doc-content]#Add#* to add and save them. You
should use the "_secret text_" type to store your API key. Test your
connection with Bluemix by clicking *[.style-scope .doc-content]#Test
Connection#*.
* In the *[.style-scope .doc-content]#Build Job Name#* field, specify
your build job's name exactly as it is in Jenkins. If the build occurs
with the test job, leave this field empty. If the build job occurs
outside of Jenkins, select the *[.style-scope .doc-content]#Builds are
being done outside of Jenkins#* check box and specify the build number
and build URL.
* For the environment, if the tests are running in build stage, select
only the build environment. If the tests are running in the deployment
stage, select the deploy environment and specify the environment name. 
* For the *[.style-scope .doc-content]#Result File Location#* field,
specify the result file's location. If the test doesn't generate a
result file, leave this field empty. The plugin uploads a default result
file that is based on the status of current test job.
* For the *SonarQube hostname* and *SonarQube authentication token*
fields, specify the hostname and token that are configured on your
SonarQube Server. For the *SonarQube project key* field, specify the
project key of the SonarQube project that you wish to scan. 
+
These images show example configurations: +
[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/Upload-Build-Info.png[Publish
build information,title="Publish build information",width=550]#
+
_Publish build information_
+
[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/Upload-Test-Result.png[image,width=550]#

_Publish test result_

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/Upload-SQ-Data.png[image,width=550]#

_Publish SonarQube test result_

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/Upload-Deployment-Info.png[image,width=550]#

__Publish deployment information__

___ +
___4. If you want to use DevOps Insights policy gates to control a
downstream deployment job, add a post-build
action, **[.style-scope .doc-content]#IBM Cloud DevOps Gate#**. Choose a
policy and specify the scope of the test results. To allow the policy
gates to prevent downstream deployments, select
the **[.style-scope .doc-content]#Fail the build based on the policy
rules#** check box. The following image shows an example configuration:

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/DRA-Gate.png[image,width=550]#

 

{empty}5. Run your Jenkins Build job.

{empty}6. View the Risk Analysis dashboard by going
to https://console.ng.bluemix.net/devops[IBM Cloud DevOps], selecting
your toolchain, and clicking [.style-scope .doc-content]#DevOps
Insights#.

 

The Risk Analysis dashboard relies on the presence of a gate after a
staging deployment job. If you want to use the dashboard, make sure that
you have a gate after you deploy to the staging environment, but before
you deploy to a production environment.

 

[[IBMCloudDevOpsPlugin-Notifyingtoolchains]]
== Notifying toolchains

You can configure your Jenkins jobs to send notifications to tools
integrated to your toolchain (e.g., Slack, PagerDuty), and use
traceability to track code deployments through tags, labels, and
comments in your Git repository (repo).

 +

Both Freestyle projects and Pipeline are supported.

[[IBMCloudDevOpsPlugin-Prerequisites.1]]
=== Prerequisites

[[IBMCloudDevOpsPlugin-Createatoolchain]]
==== Create a toolchain

Refer to
https://console.ng.bluemix.net/docs/services/ContinuousDelivery/toolchains_integrations.html#jenkins[IBM
Cloud documentation] in order to create a tool chain  that will
integrate your Jenkins server to other tools such as Github, Insights,
Slack and PagerDuty. 

[.confluence-embedded-file-wrapper .confluence-embedded-manual-size]#image:docs/images/sample_tool_chain.png[image,width=500]#

* Slack integration is detailed in the
https://console.ng.bluemix.net/docs/services/ContinuousDelivery/toolchains_integrations.html#slack[IBM
Cloud documentation].
* PagerDuty integration is detailed in the
https://console.ng.bluemix.net/docs/services/ContinuousDelivery/toolchains_integrations.html#pagerduty[IBM
Cloud documentation].

[[IBMCloudDevOpsPlugin-JenkinsWebhookURL]]
==== Jenkins Webhook URL

. On your tool chain main page, click the 3 dots in top right corner of
the Jenkins tile, and select configure.
. Take note - copy / paste it in a notepad - of the Generated toolchain
webhook URL. Webhook URL uses a format like: +
https://jenkinsc3cd97bc-b987-43bd-8020-c14bd1b1366a:8996de45-380a-40b2-a099-65a6eeb9a466@devops-api.ng.bluemix.net/[https://jenkins:c3cd97bc-b987-43bd-8020-c14bd1b1366a:8996de45-380a-40b2-a099-65a6eeb9a466@devops-api.ng.bluemix.net/v1/toolint/messaging/webhook/publish]

[[IBMCloudDevOpsPlugin-AddbluemixcredentialstoJenkins]]
==== Add bluemix credentials to Jenkins

This configuration step is common to both Freestyle or Pipeline
projects.

. On the Manage Jenkins page, select Manage Credentials
. Scope: global
. Username: your IBM Cloud user id
. Password: corresponding password
. ID: IBM_CLOUD_DEVOPS_CREDS
. (optional) Description: IBM Cloud creds
. Save your changes

These credentials will be used in Freestyle or Pipeline jobs using the
credentials ID.

 +

[[IBMCloudDevOpsPlugin-Freestylejob]]
=== Freestyle job

. Create a new Freestyle project
. Select "This project is parameterized".
. Add the String following parameters:
+
[cols="<,<",options="header",]
|===
|Name |Default Value
|IBM_CLOUD_DEVOPS_ORG |the IBM Cloud org where your application is
deployed

|IBM_CLOUD_DEVOPS_SPACE |the IBM Cloud space where your application is
deployed

|IBM_CLOUD_DEVOPS_APP_NAME |the name of your application as deployed to
IBM Cloud

|IBM_CLOUD_DEVOPS_WEBHOOK_URL |the Jenkins webhook URLof your toolchain
|===
+
[.confluence-embedded-file-wrapper]#image:docs/images/freestyle_params.png[image]#
. Source Code Management: select Git, and enter the URL and branch of
the Git repository as configured in your toolchain. +
[.confluence-embedded-file-wrapper]#image:docs/images/freestyle_git_repo.png[image]# +
 +
. Build triggers: select Poll SCM in order to start job automatically
after a Git commit. Enter your schedule options. +
[.confluence-embedded-file-wrapper]#image:docs/images/freestyle_git_poll_scm.png[image]# +
 +
. Build Environment +
- Select Use secret text(s) or file(s) +
- Add Username and password (separated) +
- Username Variable: IBM_CLOUD_DEVOPS_CREDS_USR +
- Password Variable: IBM_CLOUD_DEVOPS_CREDS_PSW +
- Credentials: select the IBM Cloud specific credentials you added to
Jenkins server  +
[.confluence-embedded-file-wrapper]#image:docs/images/freestyle_bindings.png[image]# +
 +
.  Build step is not detailed here, as the script deploying your
application to bluemix might be specific to your environment. +
 Below is a simple sample Shell script example that pushes your
application to IBM Cloud. 
+
[source,syntaxhighlighter-pre]
----
cf api https://api.ng.bluemix.net
cf login -u $IBM_CLOUD_DEVOPS_CREDS_USR -p $IBM_CLOUD_DEVOPS_CREDS_PSW -o $IBM_CLOUD_DEVOPS_ORG -s $IBM_CLOUD_DEVOPS_SPACE
cf push $IBM_CLOUD_DEVOPS_APP_NAME -n $IBM_CLOUD_DEVOPS_APP_NAME
----
. Post-build action: add the Notify OTC post-build action.
. Select the options matching your needs: +
- Notify Slack on Job started, completed or finalized events, +
- Notify PagerDuty on Job faliures only +
- Select Track deployment of code changes to enable traceability to
track code deployments through tags, labels, and comments in your Git
repository. +
[.confluence-embedded-file-wrapper]#image:docs/images/freestyle_post_build.png[image]# +
 +
. Save your changes.
. You may test your Freestyle job by either: +
- Jenkins: select "Build with parameters" and launch a build. +
- Git: commit some changes and wait for SCM polling (if enabled) to pick
up the changes and launch a build.

 +

[[IBMCloudDevOpsPlugin-Pipeline]]
=== Pipeline

. Create a new Pipeline.
. Deployment script is not detailed here. To use IBM Cloud DevOps with
the Jenkins pipeline project, you can follow
the https://github.com/jenkinsci/ibm-cloud-devops-plugin/blob/master/Declarative-Jenkinsfile-With-OTCNotifications[declarative] and https://github.com/jenkinsci/ibm-cloud-devops-plugin/blob/master/Scripted-Jenkinsfile-With-OTCNotifications[scripted ]examples

[[IBMCloudDevOpsPlugin-PublishthestatusofyourpipelinestagestoyourBluemixToolchain]]
==== Publish the status of your pipeline stages to your Bluemix Toolchain

Configure your Jenkins pipelines to send notifications to tools
integrated to your IBM Cloud Toolchain (e.g. Slack, PagerDuty).

* Ensure you added the 5 required environment variables to your script,
as detailed
https://github.ibm.com/oneibmcloud/Jenkins-IBM-Bluemix-Toolchains/blob/master/Jenkins-Pipeline-Support.md[here].
+
[source,syntaxhighlighter-pre]
----
environment {
    IBM_CLOUD_DEVOPS_CREDS = credentials('IBM_CLOUD_DEVOPS_CREDS')
    IBM_CLOUD_DEVOPS_ORG = 'dlatest'
    IBM_CLOUD_DEVOPS_APP_NAME = 'Weather-V1'
    IBM_CLOUD_DEVOPS_TOOLCHAIN_ID = '1320cec1-daaa-4b63-bf06-7001364865d2'       
    IBM_CLOUD_DEVOPS_WEBHOOK_URL =
'https://jenkins:5a55555a-a555-5555-5555-a555aa55a555:55555555-5555-5555-5555-555555555555@devops-api.ng.bluemix.net/v1/toolint/messaging/webhook/publish'
}
----
* Use the **notifyOTC **command
* (required) stageName - the name of the current pipeline stage.
* (required) status - the completion status of the current pipeline
stage. ('SUCCESS', 'FAILURE', and 'ABORTED' will be augmented with
color)
* (optional) webhookUrl - the webhook obtained from the Jenkins card on
your toolchain.
* Declarative Pipeline Example: +
+
[source,syntaxhighlighter-pre]
----
stage('Deploy') {
    steps {
      ...
    }
    post {
        success {
            notifyOTC stageName: "Deploy", status: "SUCCESS"
        }
        failure {
            notifyOTC stageName: "Deploy", status: "FAILURE"
        }
    }
}
----

[[IBMCloudDevOpsPlugin-Trackdeploymentofcodechanges]]
==== Track deployment of code changes

Configure your Jenkins pipelines to send deployable mapping messages to
your IBM Cloud toolchain, +
to track code deployments through tags, labels, and comments in your Git
repository. +
 +
Use this notification only for status 'SUCCESS'. Any other status will
be discarded.

* Add a new environment variable to your script: +
IBM_CLOUD_DEVOPS_SPACE: the IBM Cloud space where your application is
deployed
+
[source,syntaxhighlighter-pre]
----
environment {
    IBM_CLOUD_DEVOPS_CREDS = credentials('IBM_CLOUD_DEVOPS_CREDS')
    IBM_CLOUD_DEVOPS_ORG = 'dlatest'
    IBM_CLOUD_DEVOPS_SPACE= 'production'
    IBM_CLOUD_DEVOPS_APP_NAME = 'Weather-V1'
    IBM_CLOUD_DEVOPS_TOOLCHAIN_ID = '1320cec1-daaa-4b63-bf06-7001364865d2'       
    IBM_CLOUD_DEVOPS_WEBHOOK_URL =
'https://jenkins:5a55555a-a555-5555-5555-a555aa55a555:55555555-5555-5555-5555-555555555555@devops-api.ng.bluemix.net/v1/toolint/messaging/webhook/publish'
}
----
* Use the **sendDeployableMessage **command
* (required) status - the completion status of the current pipeline
stage: 'SUCCESS'
* (optional) webhookUrl - the webhook obtained from the Jenkins card on
your toolchain.
* Declarative Pipeline Example: +
+
[source,syntaxhighlighter-pre]
----
stage('Deploy') {
    steps {
      ...
    }
    post {
        success {
            notifyOTC stageName: "Deploy", status: "SUCCESS"
            sendDeployableMessage status: "SUCCESS"
        }
        failure {
            notifyOTC stageName: "Deploy", status: "FAILURE"
        }
    }
}
----
+
 +

 +

[[IBMCloudDevOpsPlugin-ChangeLog]]
== Change Log

[[IBMCloudDevOpsPlugin-Version1.0(May16th,2017)]]
=== Version 1.0 (May 16th, 2017)

* First release.

[[IBMCloudDevOpsPlugin-Version1.0.1(May17th,2017)]]
=== Version 1.0.1 (May 17th, 2017)

* Updated description.

[[IBMCloudDevOpsPlugin-Version1.0.2(May25th,2017)]]
=== Version 1.0.2 (May 25th, 2017)

* Fixed URL encoding issue

[[IBMCloudDevOpsPlugin-Version1.0.3(June2nd,2017)]]
=== Version 1.0.3 (June 2nd, 2017)

* Fixed URL encoding issue for policy dropdown list
* Minor text fix in error message

[[IBMCloudDevOpsPlugin-Version1.1.0(June08,2017)]]
=== Version 1.1.0 (June 08, 2017)

* Added Notifying toolchains section

[[IBMCloudDevOpsPlugin-Version1.1.2(July17,2017)]]
=== Version 1.1.2 (July 17, 2017)

* Support custom build number 

[[IBMCloudDevOpsPlugin-Version1.1.3(July19,2017)]]
=== Version 1.1.3 (July 19, 2017)

* Change minimum required Jenkins version

[[IBMCloudDevOpsPlugin-Version1.1.4(July24,2017)]]
=== Version 1.1.4 (July 24, 2017)

* Change environment settings to be one single global configuration for
all steps

[[IBMCloudDevOpsPlugin-Version1.1.5(July28,2017)]]
=== Version 1.1.5 (July 28, 2017)

* Throw warnings instead of errors when fails to get Jenkins root url

[[IBMCloudDevOpsPlugin-Version1.1.6(Aug10,2017)]]
=== Version 1.1.6 (Aug 10, 2017)

* Show missing required environment variables in error logs
* Fix upload SonarQube result

[[IBMCloudDevOpsPlugin-Version1.1.7(Sep6,2017)]]
=== Version 1.1.7 (Sep 6, 2017)

* Support log in using Bluemix API Key in the pipeline 
* Support lcov format for code coverage results

[[IBMCloudDevOpsPlugin-Version1.1.8(Sep13,2017)]]
=== Version 1.1.8 (Sep 13, 2017)

* Support environment variables for application name, org name in
freestyle jobs

[[IBMCloudDevOpsPlugin-Version1.1.10(Sep19,2017)]]
=== Version 1.1.10 (Sep 19, 2017)

* fix bug on uploading SonarQube result

[[IBMCloudDevOpsPlugin-Version1.1.11(Sep29,2017)]]
=== Version 1.1.11 (Sep 29, 2017)

* Support Non-ASCII characters as Jenkins job name

[[IBMCloudDevOpsPlugin-Version1.1.12(Oct19,2017)]]
=== Version 1.1.12 (Oct 19, 2017)

* Support upload security scan results

[[IBMCloudDevOpsPlugin-Version1.1.13(Nov3,2017)]]
=== Version 1.1.13 (Nov 3, 2017)

* Adapt to the global console changes

[[IBMCloudDevOpsPlugin-Version1.1.14(Jan12,2018)]]
=== Version 1.1.14 (Jan 12, 2018)

* Support custom quality data type

[[IBMCloudDevOpsPlugin-Version1.1.15(Jan18,2018)]]
=== Version 1.1.15 (Jan 18, 2018)

* Support uploading large SonarQube data

[[IBMCloudDevOpsPlugin-Version1.1.16(Jan23,2018)]]
=== Version 1.1.16 (Jan 23, 2018)

* Log errors such as the project key isn't found when publishing
SonarQube results

[[IBMCloudDevOpsPlugin-Version1.1.17(Jan30,2018)]]
=== Version 1.1.17 (Jan 30, 2018)

* handle the case when publishing SonarQube issues are over 10k limit

[[IBMCloudDevOpsPlugin-Version1.1.18(Feb22,2018)]]
=== Version 1.1.18 (Feb 22, 2018)

* enhance error handling for publishing SonarQube issues

[[IBMCloudDevOpsPlugin-Version2.0.1(Jun21,2018)]]
=== Version 2.0.1 (Jun 21, 2018)

* Add the support to IAM tokens
* Remove the dependencies on the organization name and OTC
* Minor bugs fixed and error messages enhance

[[IBMCloudDevOpsPlugin-Version2.0.2(Aug15,2018)]]
=== Version 2.0.2 (Aug 15, 2018)

* Add the support to multiple regions
* Better error message

[[IBMCloudDevOpsPlugin-Version2.0.3(Sep17,2018)]]
=== Version 2.0.3 (Sep 17, 2018)

* Fix the policy link

[[IBMCloudDevOpsPlugin-Version2.0.4(Sep27,2018)]]
=== Version 2.0.4 (Sep 27, 2018)

* Add the option to enable debug log

[[IBMCloudDevOpsPlugin-Version2.0.5(Nov15,2018)]]
=== Version 2.0.5 (Nov 15, 2018)

* Fix policy dropdown for the freestyle job
* Support custom data set for the freestyle job

[[IBMCloudDevOpsPlugin-Version2.0.6(Nov20,2018)]]
=== Version 2.0.6 (Nov 20, 2018)

* Fix output urls

[[IBMCloudDevOpsPlugin-Version2.0.7(Mar12,2019)]]
=== Version 2.0.7 (Mar 12, 2019)

* Added appName parameter to all the commands

[[IBMCloudDevOpsPlugin-Version2.0.9(Mar18,2019)]]
=== Version 2.0.9 (Mar 18, 2019)

* Changed appName parameter applicationName parameter for all the
commands. The environment variable IBM_CLOUD_DEVOPS_APP_NAME will be
ignored if this parameter is set for any step job.

[[IBMCloudDevOpsPlugin-Version2.0.12(Sep18,2019)]]
=== Version 2.0.12 (Sep 18, 2019)

* Changed Internal urls domain from bluemix.net to cloud.ibm.com

 +
 +

 +
